
// Generated by CoffeeScript 1.6.2
(function() {
    (function($) {
        return $.widget('IKS.referenceButton', {
            options: {
                uuid: '',
                editable: null
            },
            populateToolbar: function(toolbar) {
                var button, widget;

                widget = this;
                button = $('<span class="' + this.widgetName + '"></span>');
                button.hallobutton({
                    uuid: this.options.uuid,
                    editable: this.options.editable,
                    label: 'Footnote/Reference Link',
                    icon: 'icon-link',
                    command: null
                });
                toolbar.append(button);
                return button.on('click', function(event) {
                    var insertionPoint, lastSelection, img_elem;

                    lastSelection = widget.options.editable.getSelection();
                    insertionPoint = $(lastSelection.endContainer).parentsUntil('.richtext').last();
    
                    var container = $('<div class="modal fade editor" tabindex="-1" role="dialog" aria-hidden="true">\n    <div class="modal-dialog">\n        <div class="modal-content"\
>\n            <button type="button" class="close text-replace" data-dismiss="modal" aria-hidden="true"><i class="icon icon-cross"></i></button>\n            <div class="modal-body"><hea\
der class="nice-padding hasform"><div class="row"><div class="left"><div class="col"><h1><i class="icon icon-code"></i>&nbsp;Add A Footnote/Reference Link</h1></div></header><div class="modal-bo\
dy-body"></div></div>\n        </div><!-- /.modal-content -->\n    </div><!-- /.modal-dialog -->\n</div>');

                    // add container to body and hide it, so content can be added to it before display
                    $('body').append(container);

                    container.modal('hide');
                    var modalBody = container.find('.modal-body-body');

                    var footnotes = $('.fields').has('.fieldname-numeral');

                    var footnote_list = '<select id="footnote-list">';

                    $(footnotes).each(function()
                    {
                        footnote_list += '<option data-reference="' + $(this).find('.fieldname-reference').find('textarea').val() + '" data-numeral="' + $(this).find('.fieldname-numeral').find('textarea').val() + '">[' + $(this).find('.fieldname-numeral').find('textarea').val() + ']' + $(this).find('.fieldname-reference').find('textarea').val() + '</option>';
                    });
                    
                    footnote_list += '</select>';

                    modalBody.html('<p style=" margin: 2% 4%;"></p>' + footnote_list + '<button id="wagtail-edit-caption-save" type="button" style="margin: 0 4%; float: right;" class="button">Save</button>');
                    $("body").on("click", "#wagtail-edit-caption-save", function() {
                        console.log( $('#footnote-list').find("option:selected"));
                        var link = document.createElement('a');
                        var reference = $('#footnote-list').find("option:selected").attr('data-numeral');
                        $(link).attr('href', '#footnote-' + reference);
                        $(link).text('[' + reference + ']');
                        lastSelection.insertNode(link);
                        widget.options.editable.setModified();

                        modalBody.remove();
                        container.modal('hide');
                        $("body").off("click", "#wagtail-edit-caption-save");
                        return widget.options.editable.element.trigger('change');

                    });
                    container.modal('show');
                });
            }
        });
    })(jQuery);

}).call(this);